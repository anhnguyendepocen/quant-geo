---
title: "Maps in R"
author: "James B. Elsner"
date: September 25, 2018
output: 
  html_document:
    keep_md: true
---

"**...conditioning is not only something one does with ones hair, but something you also can do with data.**''---Rasmus Baath

1. Maps with ggplot2 https://eriqande.github.io/rep-res-web/lectures/making-maps-with-R.html
2. Thematic maps with tmap https://cran.r-project.org/web/packages/tmap/vignettes/tmap-getstarted.html
3. Mapping with simple features https://cran.r-project.org/web/packages/sf/vignettes/sf5.html


## Maps with ggplot2

R has a relatively simple mechanism, through the **maps** package, for making outlines of maps and plotting lat-long points and paths on them.

With the advent of packages like **sp**, **rgdal**, **rgeos**, and **sf**. R has acquired some of the functionality of traditional GIS packages.

Load the libraries we will use
```{r}
library(ggplot2)
library(maps)
library(mapdata)
```

The **maps** package contains outlines of continents, countries, states, and counties that have been with R for a long time. It comes with a plotting function but we will use **ggplot2**. The **mapdata** package contains a few more, higher-resolution outlines.

Recall that the **ggplot2** functions work on data frames. We translate the **maps** data into data frames with the `map_data()` function. The syntax is `map_data("name")` where `"name"` is a quoted string of the name of a map in the **maps** or **mapdata** package.
```{r}
usa <- map_data("usa")
dim(usa)
```

Or a  high-res world map centered on the Pacific Ocean from mapdata
```{r}
w2hr <- map_data("world2Hires")
dim(w2hr)
```

### Spatial data

Here we get the tornado data directly from the Storm Prediction Center (SPC) http://www.spc.noaa.gov/gis/svrgis/ as a shapefile.
```{r}
download.file("http://www.spc.noaa.gov/gis/svrgis/zipped/tornado.zip",
              "tornado.zip", mode = "wb")
unzip("tornado.zip")
```

The data are downloaded as a zipped file then unzipped using the `unzip()` function. This results in a folder called `torn` containing the shapefiles `torn.*`

Shapefiles can be imported in several ways. Here we use the `st_read()` function from the **sf** package.
```{r}
library(sf)
sfdf = st_read(dsn = "torn", 
               layer = "torn", 
               stringsAsFactors = FALSE)
```

The result is a simple feature collection with 23 features (attributes) and 5 fields (geometry type, dimension, bounding box, epsg, projection). To glimpse the data use the `select()`, and `head()` functions.
```{r}
sfdf %>%
  dplyr::select(date, st, mag, inj, fat, geometry) %>%
  head()
```

The `geometry` column is in well known text (WKT) format. Each tornado is a `LINESTRING` with a start and end location.

Choose only tornadoes that originated in Florida after 2000.
```{r}
df = sfdf %>%
  dplyr::filter(st == "FL", yr > 2000) %>%
  dplyr::select(yr, mo, dy, slat, slon, mag)
```
  
The **ggmap** package contains functions for creating various kinds of static maps using the **ggplot2** framework. The result is an intuitive & consistent way of specifying plots which are easy to interpret.
```{r}
Florida = get_map(location = "florida", zoom = 7)
ggmap(Florida) +
  geom_point(data = df, 
             aes(x = slon, y = slat, size = mag), alpha = .25)
```

## Thematic maps

Suppose we want to count the number of tornadoes originating in each state and then make a choropleth map of the counts? We first group and summarize.
```{r}
df = as.data.frame(sfdf) %>%
  dplyr::filter(st != "PR") %>%
  dplyr::group_by(st) %>%
  dplyr::summarize(nT = n())
glimpse(df)
```

By using the `as.data.frame()` function we 

Next we get a spatial domain. Here we use the composite counties (Alaska and Hawaii inserted) from Bob Rudis's  **albersusa** package available on GitHub. Make sure you have the **devtools** package installed.
```{r}
#devtools::install_github("hrbrmstr/albersusa")
library(albersusa)
us_sf = usa_sf("aeqd") %>%
  mutate(st = as.character(iso_3166_2))
plot(us_sf["census_area"])
```

This is the domain we want. 

Next we join the tornado counts with the map simple feature object.
```{r}
sfdf2 = left_join(df, 
                  as.data.frame(us_sf), by = "st") %>%
         sf::st_as_sf() %>%
         dplyr::select(nT)
```

Next we use the functions in the **tmap** package. The **tmap** package is a flexible, layer-based, and easy to use approach to create thematic maps including choropleths and bubble maps. It is based on the grammar of graphics, and resembles the syntax of **ggplot2**.

Functions are applied in layers with the `+` symbol. We start with the simple feature data frame called with the `tm_shape` function. Then add a polygon layer with the `tm_shape` function that points to the column in the `sfdf2` data frame that we want choroplethed.
```{r}
library(tmap)
tm_shape(sfdf2) +
  tm_polygons("nT", 
              title = "Tornado Counts",
              palette = "Reds") +
  tm_format_NLD()
```

We can improve the defaults with additional layers including text, compass, and scale bar. The last layer is the print view.
```{r}
tm_shape(sfdf2) +
  tm_polygons("nT", 
              border.col = NULL,
              title = "Tornado Counts",
              palette = "Reds") +
  tm_text("nT", size = .5) +
tm_shape(us_sf) + tm_borders(alpha = .2) +
  tm_compass() + tm_scale_bar(lwd = .5) +
  tm_format_Europe2(legend.position = c("left", "bottom"),
                attr.position = c("left", "bottom"))
```

The format of the **tmap** map objects (meoms) are like those of the **ggplot2** geometric objects (geoms) making it easy to get to a publication-quality map. The fine details can be worked out in production.

More information? See: https://cran.r-project.org/web/packages/tmap/vignettes/tmap-nutshell.html